<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self'; 
        script-src 'self' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com; 
        style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com https://unpkg.com;
        font-src 'self' https://cdnjs.cloudflare.com;
        img-src 'self' data: https://unpkg.com;
        connect-src 'self' ws: https://cdnjs.cloudflare.com https://unpkg.com; 
        object-src 'none';
        base-uri 'self';
        form-action 'self';
    ">
    <title>Enhanced AEFI Data Visualization</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous" />
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p id="loading-message">Processing your data...</p>
    </div>
    
    <header>
        <h1>Enhanced AEFI Data Visualization Tool</h1>
        <p class="subtitle">Analyze and visualize Adverse Events Following Immunization data</p>
    </header>

    <main>
    <div class="controls">
        <div class="upload-container">
            <div id="file-input-section">
                <label for="upload" class="file-label">
                    <i class="fas fa-file-excel"></i>
                    <span id="file-label-text">Upload AEFI Excel File</span>
                </label>
                <input type="file" id="upload" class="file-input" accept=".xlsx, .xls">
            </div>
            <div id="file-display-section" style="display: none;">
                <div id="file-info"></div>
                <button id="clear-data-button" class="btn-secondary">
                    <i class="fas fa-trash-alt"></i> Clear Data & Upload New File
                </button>
            </div>
        </div>
        
        <div id="status" class="status"></div>
        
        <div id="filter-section" class="filter-section">
            <div class="filter-group">
                <label for="region-filter">Region Filter</label>
                <select id="region-filter">
                    <option value="all">All Regions</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="year-filter">Year</label>
                <select id="year-filter">
                    <option value="all">All Years</option>
                </select>
            </div>

            <div class="filter-group date-range-container">
                <label for="date-from-filter">Date Range (Optional)</label>
                <div class="date-inputs">
                    <input type="date" id="date-from-filter" placeholder="From">
                    <input type="date" id="date-to-filter" placeholder="To">
                </div>
            </div>
            
            <div class="filter-group">
                <label for="vaccine-filter-display">Vaccine Filter</label>
                <div class="custom-multiselect">
                    <div class="multiselect-display" id="vaccine-filter-display">
                        All Vaccines
                    </div>
                    <div class="multiselect-dropdown" id="vaccine-dropdown">
                        <div class="multiselect-option">
                            <input type="checkbox" id="vaccine-all" value="all" checked>
                            <label for="vaccine-all">All Vaccines</label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label for="seriousness-filter">Serious / Non Serious</label>
                <select id="seriousness-filter">
                    <option value="all">All Cases</option>
                    <option value="serious">Serious Cases Only</option>
                </select>
            </div>
        </div>

        <div class="action-buttons">
                <button id="apply-filters" class="btn-primary">
                    <i class="fas fa-filter"></i> Apply Filters
                </button>
                <button id="reset-filters" class="btn-secondary">
                    <i class="fas fa-undo"></i> Reset
                </button>
                <button id="export-data" class="btn-primary">
                    <i class="fas fa-download"></i> Export
                </button>
                <div id="export-options" class="export-options">
                    <div class="export-option" data-type="pdf"><i class="fas fa-file-pdf"></i> PDF Report</div>
                    <div class="export-option" data-type="csv"><i class="fas fa-file-csv"></i> CSV Data</div>
                    <div class="export-option" data-type="png"><i class="fas fa-image"></i> PNG Images</div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="summary-section" class="summary-section">
        <h2 class="summary-title">Data Overview</h2>
        <div id="summary-stats" class="summary-stats"></div>
    </div>
    
    <div id="visualization-container">
        <div class="tabs">
            <div class="tab active" data-section="demographics">Demographics</div>
            <div class="tab" data-section="geographic">Geographic</div>
            <div class="tab" data-section="clinical">Clinical</div>
            <div class="tab" data-section="temporal">Temporal</div>
            <div class="tab" data-section="vaccine">Vaccine</div>
        </div>
        
        <div id="demographics-section" class="chart-section active">
            <div class="chart-grid">
                <div id="sexChartContainer" class="chart-container"></div>
                <div id="ageDistributionChartContainer" class="chart-container"></div>
            </div>
        </div>
        
        <div id="geographic-section" class="chart-section">
            <div class="geography-category">
                <h2>Distribution Of Health Facilities by Location</h2>
                <div class="chart-grid">
                    <div id="healthFacilityProvinceChartContainer" class="chart-container"></div>
                    <div id="districtDistributionChartContainer" class="chart-container"></div>
                </div>
            </div>
            <div class="geography-category">
                <h2>Distribution of Patient by Location</h2>
                <div class="chart-grid">
                    <div id="patientProvinceChartContainer" class="chart-container"></div>
                </div>
            </div>
            <div class="geography-category">
                <h2>Distribution of Reporter by Location</h2>
                <div class="chart-grid">
                    <div id="reporterProvinceChartContainer" class="chart-container"></div>
                </div>
            </div>
        </div>
        
        <div id="clinical-section" class="chart-section">
            <div class="chart-grid">
                <div id="adverseEventsChart" class="chart-container"></div>
                <div id="seriousnessChart" class="chart-container"></div>
                <div id="seriousReasonChart" class="chart-container"></div>
            </div>
        </div>
        
        <div id="temporal-section" class="chart-section">
            <!-- SERIOUS AEFIs SECTION -->
            <h2 class="section-heading">Serious AEFIs</h2>
            <p class="section-description">Timeline analysis for serious adverse events following immunization</p>

            <div class="chart-grid dual-chart">
                <div id="seriousIdentificationChartContainer" class="chart-container"></div>
                <div id="seriousReportingChartContainer" class="chart-container"></div>
            </div>

            <!-- NON-SERIOUS AEFIs SECTION -->
            <h2 class="section-heading">Non-Serious AEFIs</h2>
            <p class="section-description">Timeline analysis for non-serious adverse events following immunization</p>

            <div class="chart-grid dual-chart">
                <div id="nonSeriousIdentificationChartContainer" class="chart-container"></div>
                <div id="nonSeriousReportingChartContainer" class="chart-container"></div>
            </div>
        </div>
        
        <div id="vaccine-section" class="chart-section">
            <div class="chart-grid">
                <div id="vaccineDistributionChartContainer" class="chart-container"></div>
            </div>
            <div class="chart-grid">
                <div id="vaccineAdverseEventsChartContainer" class="chart-container"></div>
            </div>
        </div>
    </div>
    </main>

    <footer>
        <p>Enhanced AEFI Data Visualization Tool &copy; 2025</p>
    </footer>

    <!-- CDN Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" integrity="sha256-1G2Xof0CLF+yn6L0Xry8MiAtc67r8HbOX3JI9UmPx9c=" crossorigin="anonymous" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" integrity="sha256-yVBhl8r4CaB1tt7h2g02+xnacVj/6KiOewyWxdhiPJk=" crossorigin="anonymous" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer" defer></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous" defer></script>

    <!-- Local Scripts -->
    <script src="js/vaccine_parser.js" defer></script>
    <script src="js/utils.js" defer></script>
    <script src="js/compatibility.js" defer></script>
    <!-- Chart Modules -->
    <script src="js/charts/sex_chart.js" defer></script>
    <script src="js/charts/age_distribution_chart.js" defer></script>
    <script src="js/charts/patient_province_chart.js" defer></script>
    <script src="js/charts/health_facility_province_chart.js" defer></script>
    <script src="js/charts/district_distribution_chart.js" defer></script>
    <script src="js/charts/reporter_province_chart.js" defer></script>
    <script src="js/charts/adverse_event_chart.js" defer></script>
    <script src="js/charts/serious_event_chart.js" defer></script>
    <script src="js/charts/serious_reason_chart.js" defer></script>
    <!-- Old temporal analysis - deprecated -->
    <!-- <script src="js/charts/temporal_analysis_chart.js" defer></script> -->
    <!-- New temporal analysis - separated by serious/non-serious -->
    <script src="js/charts/event_identification_to_notification_chart.js" defer></script>
    <script src="js/charts/notification_to_reporting_chart.js" defer></script>
    <script src="js/charts/vaccine_distribution_chart.js" defer></script>
    <script src="js/charts/vaccine_adverse_events_chart.js" defer></script>
    <script src="js/main.js" defer></script>
</body>
</html>